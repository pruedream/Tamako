(window.webpackJsonp=window.webpackJsonp||[]).push([[38],{364:function(t,s,a){"use strict";a.r(s);var n=a(4),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"mysql死锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mysql死锁"}},[t._v("#")]),t._v(" MySQL死锁")]),t._v(" "),s("h2",{attrs:{id:"什么是死锁"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#什么是死锁"}},[t._v("#")]),t._v(" 什么是死锁")]),t._v(" "),s("p",[t._v("死锁是并发系统中常见的问题，"),s("strong",[t._v("一般表现为A,B同时持有对方需要的资源并上锁，A,B都在等待对方释放锁以获取对方手里的资源")]),t._v("，如此便产生了死锁。同样也会出现在数据库MySQL的并发读写请求场景中。当两个及以上的事务，双方都在等待对方释放已经持有的锁或因为加锁顺序不一致造成循环等待锁资源，就会出现“死锁”。")]),t._v(" "),s("h3",{attrs:{id:"死锁产生的四个必要条件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#死锁产生的四个必要条件"}},[t._v("#")]),t._v(" 死锁产生的四个必要条件")]),t._v(" "),s("ul",[s("li",[s("p",[s("strong",[t._v("互斥条件")]),t._v("资源是独占的且排他使用，进程互斥使用资源，即任意时刻一个资源只能给一个进程使用，其他进程若申请一个资源，而该资源被另一进程占有时，则申请者等待直到资源被占有者释放。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("不可剥夺条件")]),t._v("进程所获得的资源在未使用完毕之前，不被其他进程强行剥夺，而只能由获得该资源的进程资源释放。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("请求和保持条件")]),t._v("进程每次申请它所需要的一部分资源，在申请新的资源的同时，继续占用已分配到的资源。")])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("循环等待条件")]),t._v("在发生死锁时必然存在一个进程等待队列{P1,P2,…,Pn},其中P1等待P2占有的资源，P2等待P3占有的资源，…，Pn等待P1占有的资源，形成一个进程等待环路，环路中每一个进程所占有的资源同时被另一个申请，也就是前一个进程占有后一个进程所申请地资源。")]),t._v(" "),s("p",[t._v("以上给出了导致死锁的四个必要条件，只要系统发生死锁则以上四个条件至少有一个成立。事实上"),s("strong",[t._v("循环等待")]),t._v("的成立蕴含了前三个条件的成立，似乎没有必要列出然而考虑这些条件对死锁的预防是有利的，因为可以通过破坏四个条件中的任何一个来预防死锁的发生。")])])]),t._v(" "),s("p",[s("strong",[t._v("参考死锁的MySQL 出现死锁的几个要素为：")])]),t._v(" "),s("ol",[s("li",[t._v("两个或者两个以上事务")]),t._v(" "),s("li",[t._v("每个事务都已经持有锁并且申请新的锁")]),t._v(" "),s("li",[t._v("锁资源同时只能被同一个事务持有或者不兼容")]),t._v(" "),s("li",[t._v("事务之间因为持有锁和申请锁导致彼此循环等待")])]),t._v(" "),s("p",[t._v("举例来说 A 事务持有 X1 锁 ，申请 X2 锁，B事务持有 X2 锁，申请 X1 锁。A 和 B 事务持有锁并且申请对方持有的锁进入循环等待，就造成了死锁。")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("create table "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("money")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" primary key"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("price "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ninsert into money "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("values")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\ninsert into money "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("values")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("table",[s("thead",[s("tr",[s("th",[t._v("事务A")]),t._v(" "),s("th",[t._v("事务B")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("begin;"),s("br"),t._v("update money set price = 1500 where id =1")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td"),t._v(" "),s("td",[t._v("begin;"),s("br"),t._v("update money set price = 1500 where id =2")])]),t._v(" "),s("tr",[s("td",[t._v("update money set price = 1600 where id =2")]),t._v(" "),s("td")]),t._v(" "),s("tr",[s("td"),t._v(" "),s("td",[t._v("update money set price = 1600 where id =1")])])])]),t._v(" "),s("p",[t._v("事务A与事务B分别对ID=1与ID=2的记录加了锁，现在事务A需要获取ID=2的记录的锁，事务B需要获取ID=1的记录的锁，双方都在等对方释放锁，于是造成的死锁。")]),t._v(" "),s("h2",{attrs:{id:"死锁的解决与防范"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#死锁的解决与防范"}},[t._v("#")]),t._v(" 死锁的解决与防范")]),t._v(" "),s("p",[t._v("首先要做的就是预防死锁")])])}),[],!1,null,null,null);s.default=e.exports}}]);